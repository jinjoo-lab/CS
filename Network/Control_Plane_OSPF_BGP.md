# Control Plane (OSPF , BGP )

## OSPF ( 인터넷에서 AS 내부 라우팅 )

---

### 관점에 대하여

- LS와 DV 알고리즘에 대해 우리는 **네트워크를 상호연결된 라우터의 집합**으로 바라보았다.
    - 모든 라우터가 동일한 라우팅 알고리즘 수행
    - 라우터간의 구별이 불가능

> 네트워크를 단순히 동일한 라우팅 알고리즘을 수행하는 라우터의 집합으로 바라보는 것은 문제가 있다.
>

**확장**

- 라우터의 수가 증가 → 오베헤드 증가
    - 라우터 정보를 저장하기 위해서는 **메모리** 필요
    - 링크 비용을 브로드캐스트하는데 **오버헤드**

**관리 자율성**

- 각 ISP는 자신의 네트워크 관리 → 독립적인 운용 방식과 내부 구성의 캡슐화를 원한다.

> 이러한 한계를 극복하기 위해 라우터들을 **자율 시스템(AS)**로 조직화
>

### AS ( 자율 시스템 )

> **동일한 관리 제어**하에 있는 **라우터의 그룹**
>
- AS는 전세계적으로 고유한 **AS번호로 식별**
- **같은 AS**안의 라우터들 **동일한 라우팅 알고리즘** 사용 → 상대방에 대한 정보를 가지고 있다.
- AS 내부 라우팅 프로토콜 → 자율 시스템 내부에서 동작하는 라우팅 알고리즘

### OSPF ( 개방형 최단 경로 우선) 프로토콜

> AS내부에서 수행되는 라우팅 프로토콜
>
- OPEN : 라우팅 프로토콜의 동작 방식이 공개되어 있다.
- 링크 상태 정보를 플러딩(flooding)하고 **다익스트라 최소 비용 경로 알고리즘**을 사용하는 **링크 상태 알고리즘**
    - 각 라우터는 전체 AS에 대한 완벽한 토폴로지를 얻는다.
    - 각 라우터는 **자신을 루트**로 하고 각 **서브넷**에 이르는 최단 경로 트리 결정 ( 다익스트라 알고리즘 )
- OSPF는 링크의 가중치 설정 방법을 특정하지 않는다.
- OSPF 라우터는 **AS내의 모든 라우터**에게 라우팅 정보를 **브로드캐스팅**
    - 링크 상태 변경 or 일정 주기
1. **보안**
    - OSPF 라우터들 간 정보 교환을 인증 (갱신 시 인증 추가 가능) → 신뢰할 수 있는 라우터만 프로토콜에 참여
        - 단순 인증
            - 각 라우터에 **동일한 패스워드** 설정
            - OSPF 패킷을 보낼 때 패스워드를 평문에 그대로 포함
        - MD5 인증
            - 모든 라우터에 설정된 **공유 비밀키**를 기반으로 동작
2. **복수 비용 동일 경로**
    - 동일한 비용을 가진 여러 개의 경로가 존재할 때 OSPF는 여러 개의 경로 사용 가능
3. **유니캐스트 & 멀티캐스트 라우팅의 통합 지원**
4. **단일 AS내에서 계층 지원**
    - AS는 계층적인 영역으로 구성될 수 있다.
    - 영역 내의 라우터는 같은 영역 내의 라우터들에게만 브로드캐스트
    - **영역 경계 라우터**가 영역 외부로 패킷 라우팅을 책임진다.

## BGP ( ISP 간의 라우팅 )

---

> **경계 게이트웨이 프로토콜**로 AS간의 라우팅 프로토콜 수행
>
- 패킷이 여러 AS를 통과하도록 라우팅할 때 **자율 시스템간의 라우팅 프로토콜**이 필요하다.
- 인터넷에 있는 수천개의 ISP들을 연결하는 프로토콜
- 분산형 비동기식 프로토콜

> BGP에서는 패킷이 특정 목적지 주소를 향해서가 아닌 **CIDR형식으로 표현된 , 주소의 앞쪽 Prefix를** 향해 전달된다.
>
- 이웃 AS를 통해 **도달 가능한 서브넷 프리픽스** 정보를 얻는다.
    - BGP는 서브넷의 존재를 인터넷 전체에 알릴 수 있다
- 서브넷 주소 프리픽스로의 가장 좋은 경로 결정
    - BGP의 경로 결정 프로시저를 수행 → 경로 정보 + 정책

### BGP 경로 정보 알리기

- AS의 라우터
    - **게이트웨이 라우터 : AS의 경계**에 있는 라우터  (다른 AS들에 있는 여러 개의 라우터와 직접 연결)
    - **내부 라우터 :** 자신의 **AS 내에 있는 호스트** 및 **라우터**와만 연결

![Untitled](Control%20Plane%20(OSPF%20,%20BGP%20)%20d5cb153934354818914c09d585893a0c/Untitled.png)

- 추상적 과정

> 단순하게 기술하자면 AS간의 전송을 통해 목적지 프리픽스를 전달하는 것이다.
>
- 실제 과정
    - BGP에서 라우터들은 **반영구적 TCP 연결**을 통해 **라우팅 정보 교환**
        - 모든 BGP 메시지가 전송되는데 이 연결을 BGP 연결이라 한다.
    - **외부 BGP 연결 (eBGP)**
        - 2개의 AS를 연결
    - **내부 BGP 연결 (iBGP)**
        - 같은 AS 내의 라우터 간 BGP 연결

> 라우터들간의 통신을 통해 BGP가 동작하는데 AS간의 연결과 동일한 AS간의 연결에서의 통신을 통해 수행한다.
>

## 최적 경로 결정

> BGP를 통해 우리는 목적지의 프리픽스에 대한 경로를 알 수 있다. 하지만 상황에 따라 이러한 경로는 1개 이상일 수 있고 우리는 최적의 경로를 찾아야 한다.
>
- 라우터가 BGP 연결을 통해 주소 프리픽스 전달 시 **BGP 속성**도 포함
    - **AS-PATH**
        - **알림 메시지가 통과하는 AS들의 리스트**
        - 메시지의 루프 감지와 방지 가능
    - **NEXT-HOP**
        - **AS-PATH가 시작되는 라우터 인터페이스의 IP 주소**

### Hot Potato Routing

> 가능한 모든 BGP 경로에서 경로 시작점인 **NEXT-HOP 라우터까지의 경로 비용이 최소**가 되는 경로로 결정하는 알고리즘
>
- 최소한의 비용으로 패킷을 자신의 AS 밖으로 내보내는 것 (자신의 AS 내부 비용을 줄이는 방식)

![Untitled](Control%20Plane%20(OSPF%20,%20BGP%20)%20d5cb153934354818914c09d585893a0c/Untitled%201.png)

### 전체적 과정

1. 여러 게이트웨이를 통해 서브넷 도달 사실을 **AS간 프로토콜(BGP)**를 통해 파악
2. 각 게이트웨이까지의 최소 비용 경로 결정 위해 **AS 내부 프로토콜 이용(OSPF)**
3. **Hot Potato Routing** : 가장 적은 비용의 게이트웨이 선택
4. 포워딩 테이블에 결정 정보 추가

### 제거 규칙

1. 지역 선호도 (최고 지역 선호 값을 가진 경로 결정)
2. 최단 AS-PATH 결정
3. HOT - POTATO 라우팅 수행
4. BGP 식별자 사용

### IP 애니캐스트

> DNS에서 사용되는 IP 애니캐스트 구현에도 BGP 사용
>
- 같은 콘텐츠를 지리적으로 분순된 서버에 복제
- 각 사용자를 가까운 서버의 콘텐츠에 접근

### 지역 선호도 ?

> 라우터가 목적지까지 경로 결정 시 **AS 라우팅 정책**은 모든 고려서항보다 우선시
>
- BGP 경로의 알림 방식을 제어
    - 자기 자신을 제외하고는 어떤 목적지로도 경로가 없다 알림

### AS 내 외부 라우팅 프로토콜이 다른 이유

1. 정책
    - AS 간 라우팅은 정책 지향
2. 확장성
    - AS 간 라우팅에서 확장성을 위한 알고리즘과 자교 구조의 능력은 중요한 문제
    - AS 내부에서는 확장성이 엄청 중요한 문제는 아니다. ( 분리 )
3. 성능
    - AS 간 라우팅은 정책 지향형
    - AS 내부 라우팅에는 성능이 중요 초점
